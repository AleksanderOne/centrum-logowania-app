name: Mutation Testing (Stryker)

# Uruchamianie:
# 1. RÄ™cznie przez GitHub Actions UI (workflow_dispatch)
# 2. Automatycznie w niedzielÄ™ o 3:00 (scheduled)
# 3. Na PR do main (opcjonalnie - wyÅ‚Ä…czone domyÅ›lnie bo wolne)
on:
  # RÄ™czne uruchomienie z GitHub UI
  workflow_dispatch:
    inputs:
      concurrency:
        description: 'Liczba rÃ³wnolegÅ‚ych procesÃ³w mutacji'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '4'
          - '8'
      incremental:
        description: 'Tylko zmienione pliki (incremental)'
        required: false
        default: false
        type: boolean

  # Automatyczne uruchomienie w niedzielÄ™ o 3:00 UTC
  schedule:
    - cron: '0 3 * * 0'

  # Opcjonalnie: na PR do main (odkomentuj jeÅ›li chcesz)
  # pull_request:
  #   branches: [main]
  #   paths:
  #     - 'src/**/*.ts'
  #     - 'src/**/*.tsx'

permissions:
  contents: read
  # Pozwala na komentowanie PR z wynikami
  pull-requests: write

jobs:
  mutation-test:
    name: ğŸ§¬ Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ§¬ Run Stryker Mutation Testing
        run: |
          echo "ğŸ§¬ Uruchamiam testy mutacyjne..."
          echo "ğŸ“Š Concurrency: ${{ github.event.inputs.concurrency || '4' }}"
          echo "â„¹ï¸ UÅ¼ywam command runner (kompatybilny z Vitest 4)"
          npm run test:mutation -- --concurrency ${{ github.event.inputs.concurrency || '4' }}
        env:
          CI: true
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: ğŸ“Š Upload Mutation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-report-${{ github.run_id }}
          path: reports/mutation/
          retention-days: 30

      - name: ğŸ“ Generate Summary
        if: always()
        run: |
          echo "## ğŸ§¬ Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "reports/mutation/mutation-report.json" ]; then
            # Parsowanie wynikÃ³w z JSON
            KILLED=$(cat reports/mutation/mutation-report.json | jq '.files | to_entries | map(.value.mutants | map(select(.status == "Killed")) | length) | add // 0')
            SURVIVED=$(cat reports/mutation/mutation-report.json | jq '.files | to_entries | map(.value.mutants | map(select(.status == "Survived")) | length) | add // 0')
            TIMEOUT=$(cat reports/mutation/mutation-report.json | jq '.files | to_entries | map(.value.mutants | map(select(.status == "Timeout")) | length) | add // 0')
            NO_COVERAGE=$(cat reports/mutation/mutation-report.json | jq '.files | to_entries | map(.value.mutants | map(select(.status == "NoCoverage")) | length) | add // 0')
            
            TOTAL=$((KILLED + SURVIVED + TIMEOUT + NO_COVERAGE))
            if [ $TOTAL -gt 0 ]; then
              SCORE=$(echo "scale=2; ($KILLED * 100) / $TOTAL" | bc)
            else
              SCORE=0
            fi
            
            echo "| Metryka | WartoÅ›Ä‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ’€ Zabite mutanty | $KILLED |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ§Ÿ PrzeÅ¼yÅ‚e mutanty | $SURVIVED |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Timeout | $TIMEOUT |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸš« Bez pokrycia | $NO_COVERAGE |" >> $GITHUB_STEP_SUMMARY
            echo "| **ğŸ“Š Mutation Score** | **${SCORE}%** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if (( $(echo "$SCORE >= 80" | bc -l) )); then
              echo "âœ… **Åšwietny wynik!** Testy sÄ… wysokiej jakoÅ›ci." >> $GITHUB_STEP_SUMMARY
            elif (( $(echo "$SCORE >= 60" | bc -l) )); then
              echo "âš ï¸ **Dobry wynik.** Jest miejsce na poprawÄ™." >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Niski wynik.** RozwaÅ¼ dodanie lepszych asercji do testÃ³w." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Nie znaleziono raportu mutacji." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¥ PeÅ‚ny raport HTML dostÄ™pny w Artifacts." >> $GITHUB_STEP_SUMMARY

      # Opcjonalnie: komentarz na PR z wynikami
      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ğŸ§¬ Mutation Testing Results\n\n';
            
            try {
              const report = JSON.parse(fs.readFileSync('reports/mutation/mutation-report.json', 'utf8'));
              const files = Object.entries(report.files || {});
              
              let killed = 0, survived = 0, timeout = 0, noCoverage = 0;
              
              files.forEach(([, file]) => {
                (file.mutants || []).forEach(m => {
                  if (m.status === 'Killed') killed++;
                  else if (m.status === 'Survived') survived++;
                  else if (m.status === 'Timeout') timeout++;
                  else if (m.status === 'NoCoverage') noCoverage++;
                });
              });
              
              const total = killed + survived + timeout + noCoverage;
              const score = total > 0 ? ((killed / total) * 100).toFixed(2) : 0;
              
              comment += `| Metryka | WartoÅ›Ä‡ |\n`;
              comment += `|---------|:-------:|\n`;
              comment += `| ğŸ’€ Zabite | ${killed} |\n`;
              comment += `| ğŸ§Ÿ PrzeÅ¼yÅ‚e | ${survived} |\n`;
              comment += `| **ğŸ“Š Score** | **${score}%** |\n\n`;
              
              if (score >= 80) {
                comment += 'âœ… Åšwietna jakoÅ›Ä‡ testÃ³w!';
              } else if (score >= 60) {
                comment += 'âš ï¸ Dobra jakoÅ›Ä‡, ale jest miejsce na poprawÄ™.';
              } else {
                comment += 'âŒ RozwaÅ¼ dodanie lepszych asercji.';
              }
            } catch (e) {
              comment += 'âš ï¸ Nie udaÅ‚o siÄ™ sparsowaÄ‡ raportu.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

