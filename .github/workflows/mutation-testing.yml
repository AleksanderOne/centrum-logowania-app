name: ğŸ§¬ Testy Mutacyjne (Stryker)

# Uruchamianie rÄ™czne przez GitHub Actions UI
# UÅ¼yj tego workflow do dodatkowej weryfikacji jakoÅ›ci testÃ³w
on:
  workflow_dispatch:
    inputs:
      concurrency:
        description: 'Liczba rÃ³wnolegÅ‚ych procesÃ³w mutacji'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '4'
          - '8'
      incremental:
        description: 'Tylko zmienione pliki (incremental)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write

jobs:
  testy-mutacyjne:
    name: ğŸ§¬ Testy Mutacyjne
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      score: ${{ steps.wyniki.outputs.score }}
      killed: ${{ steps.wyniki.outputs.killed }}
      survived: ${{ steps.wyniki.outputs.survived }}
      total: ${{ steps.wyniki.outputs.total }}
      status: ${{ steps.wyniki.outputs.status }}

    steps:
      - name: ğŸ“¥ Pobieranie Kodu
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Konfiguracja Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: ğŸ“š Instalacja ZaleÅ¼noÅ›ci
        run: npm ci

      - name: ğŸ§¬ Uruchamianie TestÃ³w Mutacyjnych
        run: |
          echo "ğŸ§¬ Rozpoczynam testy mutacyjne..."
          echo "ğŸ“Š Liczba rÃ³wnolegÅ‚ych procesÃ³w: ${{ github.event.inputs.concurrency || '4' }}"
          echo "â„¹ï¸ Tryb incremental: ${{ github.event.inputs.incremental || 'false' }}"
          echo "ğŸ”§ UÅ¼ywam command runner (kompatybilny z Vitest 4)"
          
          if [ "${{ github.event.inputs.incremental }}" == "true" ]; then
            npm run test:mutation -- --incremental --concurrency ${{ github.event.inputs.concurrency || '4' }}
          else
            npm run test:mutation -- --concurrency ${{ github.event.inputs.concurrency || '4' }}
          fi
        env:
          CI: true
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: ğŸ“Š PrzesyÅ‚anie Raportu Mutacji
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: raport-mutacji-${{ github.run_id }}
          path: reports/mutation/
          retention-days: 30

      - name: ğŸ“ Generowanie Podsumowania i WyÅ›wietlanie WynikÃ³w
        id: wyniki
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§¬ WYNIKI TESTÃ“W MUTACYJNYCH"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          if [ -f "reports/mutation/mutation-report.json" ]; then
            # Parsowanie wynikÃ³w z JSON
            KILLED=$(cat reports/mutation/mutation-report.json | jq '.files | to_entries | map(.value.mutants | map(select(.status == "Killed")) | length) | add // 0')
            SURVIVED=$(cat reports/mutation/mutation-report.json | jq '.files | to_entries | map(.value.mutants | map(select(.status == "Survived")) | length) | add // 0')
            TIMEOUT=$(cat reports/mutation/mutation-report.json | jq '.files | to_entries | map(.value.mutants | map(select(.status == "Timeout")) | length) | add // 0')
            NO_COVERAGE=$(cat reports/mutation/mutation-report.json | jq '.files | to_entries | map(.value.mutants | map(select(.status == "NoCoverage")) | length) | add // 0')
            
            TOTAL=$((KILLED + SURVIVED + TIMEOUT + NO_COVERAGE))
            if [ $TOTAL -gt 0 ]; then
              SCORE=$(echo "scale=2; ($KILLED * 100) / $TOTAL" | bc)
            else
              SCORE=0
            fi
            
            # WyÅ›wietlanie w konsoli
            echo "ğŸ“Š Statystyki:"
            echo "   ğŸ’€ Zabite mutanty:     $KILLED"
            echo "   ğŸ§Ÿ PrzeÅ¼yÅ‚e mutanty:   $SURVIVED"
            echo "   â±ï¸  Timeout:            $TIMEOUT"
            echo "   ğŸš« Bez pokrycia:        $NO_COVERAGE"
            echo "   ğŸ“ˆ ÅÄ…cznie mutantÃ³w:    $TOTAL"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Mutation Score: ${SCORE}%"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            if (( $(echo "$SCORE >= 80" | bc -l) )); then
              echo "âœ… Åšwietny wynik! Testy sÄ… wysokiej jakoÅ›ci."
              STATUS_EMOJI="âœ…"
              STATUS_TEXT="Åšwietny wynik! Testy sÄ… wysokiej jakoÅ›ci."
            elif (( $(echo "$SCORE >= 60" | bc -l) )); then
              echo "âš ï¸  Dobry wynik. Jest miejsce na poprawÄ™."
              STATUS_EMOJI="âš ï¸"
              STATUS_TEXT="Dobry wynik. Jest miejsce na poprawÄ™."
            else
              echo "âŒ Niski wynik. RozwaÅ¼ dodanie lepszych asercji do testÃ³w."
              STATUS_EMOJI="âŒ"
              STATUS_TEXT="Niski wynik. RozwaÅ¼ dodanie lepszych asercji do testÃ³w."
            fi
            
            echo ""
            echo "ğŸ“¥ PeÅ‚ny raport HTML dostÄ™pny w sekcji Artifacts powyÅ¼ej."
            echo ""
            
            # Generowanie podsumowania dla GitHub Actions Summary
            echo "## ğŸ§¬ Wyniki TestÃ³w Mutacyjnych" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“Š Statystyki" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metryka | WartoÅ›Ä‡ |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ’€ Zabite mutanty | **$KILLED** |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ§Ÿ PrzeÅ¼yÅ‚e mutanty | **$SURVIVED** |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Timeout | $TIMEOUT |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸš« Bez pokrycia | $NO_COVERAGE |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ“ˆ ÅÄ…cznie mutantÃ³w | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“Š Mutation Score" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${SCORE}%**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$STATUS_EMOJI **$STATUS_TEXT**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“¥ **PeÅ‚ny raport HTML** dostÄ™pny w sekcji [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”— Link do tego uruchomienia: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
            
            # Zapisanie wynikÃ³w jako outputs (widoczne w GitHub Actions UI)
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "killed=$KILLED" >> $GITHUB_OUTPUT
            echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "status=$STATUS_TEXT" >> $GITHUB_OUTPUT
            
            # Zapisanie wynikÃ³w do pliku dla nastÄ™pnego kroku
            echo "KILLED=$KILLED" >> $GITHUB_ENV
            echo "SURVIVED=$SURVIVED" >> $GITHUB_ENV
            echo "TIMEOUT=$TIMEOUT" >> $GITHUB_ENV
            echo "NO_COVERAGE=$NO_COVERAGE" >> $GITHUB_ENV
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
            echo "SCORE=$SCORE" >> $GITHUB_ENV
            echo "STATUS_EMOJI=$STATUS_EMOJI" >> $GITHUB_ENV
            echo "STATUS_TEXT=$STATUS_TEXT" >> $GITHUB_ENV
          else
            echo "âš ï¸ Nie znaleziono raportu mutacji."
            echo "âš ï¸ Nie znaleziono raportu mutacji." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“‹ Podsumowanie WynikÃ³w w Konsoli
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… WYNIKI ZOSTAÅY WYGENEROWANE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Wyniki sÄ… widoczne w:"
          echo "   1. GitHub Actions Summary (na gÃ³rze tej strony)"
          echo "   2. Artifacts (peÅ‚ny raport HTML)"
          echo "   3. Outputs tego joba (poniÅ¼ej)"
          echo ""
          echo "ğŸ”— Link do tego uruchomienia:"
          echo "   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
